import { Meta } from '@storybook/addon-docs'

<Meta
  title="Development/Testing"
  parameters={{
    previewTabs: {
      canvas: { hidden: true },
    },
  }}
/>

<bal-doc-banner id="testing" subtitle="Development">Testing</bal-doc-banner>

<bal-doc-lead>
  The Baloise Design System provides a collection of utility functions to test the web-components. Since the
  web-components are executed async we need to wait for them in the test.
</bal-doc-lead>

## Component Testing (Unit)

To write unit test we recommend those tools:

- [Karma + Jasmin](https://angular.io/guide/testing)
- [Cypress Component Testing](https://docs.cypress.io/guides/component-testing/overview)

### Karma + Jasmin

This is also the the default testing tools of the Angular framework.

```typescript
import { CUSTOM_ELEMENTS_SCHEMA } from '@angular/core'
import { TestBed } from '@angular/core/testing'
import { BrowserModule, By } from '@angular/platform-browser'
import { BaloiseDesignSystemModule } from '@baloise/design-system-components-angular'
import { waitForDesignSystem } from '@baloise/design-system-components'
import { AppComponent } from './app.component'

describe('AppComponent', () => {
  beforeEach(async () => {
    await TestBed.configureTestingModule({
      declarations: [AppComponent],
      imports: [BrowserModule, BaloiseDesignSystemModule.forRoot()],
      schemas: [CUSTOM_ELEMENTS_SCHEMA],
    }).compileComponents()
  })

  it(`should render input value`, async () => {
    const fixture = TestBed.createComponent(AppComponent)
    fixture.detectChanges()

    // waits until the Design System has been initialized and the async
    // web components have been rendered
    await waitForDesignSystem()

    const input = fixture.debugElement.query(By.css('[data-testid="input"]'))
    expect(input.nativeElement.value).toContain('My Value')
  })
})
```

Use the `waitForDesignSystem` util function to wait until the web-component tree has fully rendered.

To wait after a user interaction use the util function `waitForComponent`.

```typescript
button.click()
await fixture.whenStable()
await waitForComponent(fixture.nativeElement)

// now we can do the assertions
expect(component.onEditButtonClick).toHaveBeenCalled()
```

#### Utils

The Design System provides some utilities to write stable unit tests. All functions return a promise and can be resolved with `await`.

```typescript
await waitForDesignSystem()
```

| Util                                             | Description                                                                                                                                              |
| ------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `waitForDesignSystem(config?: BalConfig \| any)` | waits until the Design System has initialized and disables all animations. Moreover, it waits unit all components are ready and the first print is done. |
| `waitForComponent(el: HTMLElement)`              | Waits until the component and his nested components has rendered.                                                                                        |
| `waitAfterFramePaint()`                          | Waits until the browser has updated the DOM                                                                                                              |
| `waitAfterIdleCallback()`                        | Waits until the browser goes in idle mode.                                                                                                               |

## Component Testing with Cypress

We recommend to use the [Component Testing with Cypress](https://docs.cypress.io/guides/component-testing/overview).
Follow their installations guide.

### Configure

First install out testing library

```bash
npm add -D @baloise/design-system-testing
```

Go to the file `cypress/support/commands.ts` and import the testing library.
After that you have access to all our custom cypress commands

```typescript
/// <reference types="cypress" />

import '@baloise/design-system-testing'
```

Open the file `component-index.html` and use `bal-app`

```html
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Components App</title>
  </head>
  <body>
    <bal-app data-cy-root></bal-app>
  </body>
</html>
```

### First Test

We created a simple component with our CSS-Framework and the components.

```html
<div class="p-large">
  <h1 class="title">Native Title</h1>
  <bal-heading>Component Title</bal-heading>
</div>
```

Lets create our first test `hello.component.cy.ts`.

```typescript
import { BaloiseDesignSystemModule } from '@baloise/design-system-components-angular'
import { HelloComponent } from 'src/app/hello/hello.component'

describe('hello.component.cy.ts', () => {
  it('playground', () => {
    // mount the angular component and import the needed
    // Design System modules
    cy.mount(HelloComponent, {
      imports: [BaloiseDesignSystemModule.forRoot()],
    })
    // lets wait until the Design System has loaded the custom font, Â¨
    // disabled the animations and the web-components have rendered
    cy.waitForDesignSystem()

    cy.get('bal-heading').contains('Component Title')
  })
})
```

## E2E Testing with Cypress

We provide collection of custom cypress commands for our components. Moreover, some basic
cypress commands like <b>should</b> or <b>click</b> have been overridden to work with our components.

### Prerequisites

For E-2-E testing we recommend to use the testing framework [Cypress](https://www.cypress.io/).

If you are using Vue or Angular please install Cypress with the provided CLI.

### Install testing library

Install the library directly from npm.

```bash
npm add -D @baloise/design-system-testing
```

Next step is to add the commands to our cypress setup. Open the file `cypress/support/commands.ts` and import the testing library.

```typescript
import '@baloise/design-system-testing'
```

Now the adjusted commands from the Baloise Design System should be available in your test files.

### Usage

Further documentations for each component commands is documented on the components page.

```typescript
import { byTestId, selectors } from '@baloise/design-system-testing'

describe('Accordion', () => {
  const accordion = byTestId('my-accordion') // [data-testid="my-accordion"]

  it('should ...', () => {
    cy.get(accordion).find(selectors.accordion.trigger).contains('Show more')
    cy.get(accordion).balAccordionIsClosed()
    cy.get(accordion).click().balAccordionIsOpen()
    cy.get(accordion).find(selectors.accordion.trigger).contains('Show less')
    cy.get(accordion).find(selectors.accordion.content).contains('My Content')
    cy.get(accordion).click().balAccordionIsClosed()
  })
})
```

### Selectors

It is recommended to set specific test attributes `data-testid` on the elements to test.

```html
<bal-button data-testid="my-button"></bal-button>
```

To build up the correct selector like this `[data-testid="my-button"]` we use the helper function `byTestId`. This selector can then be used directly with the cypress commands.

```typescript
import { byTestId } from '@baloise/design-system-testing'

describe('Button', () => {
  it('should ...', () => {
    cy.getByTestId('button-id').click()
  })

  // or with the selector function

  it('should ...', () => {
    const button = byTestId('button-id')
    cy.get(button).click()
  })
})
```

### Component Selectors (WIP)

For each component we define internally some data-testid selectors.

```typescript
import { selectors } from '@baloise/design-system-testing'

describe('Accordion', () => {
  it('should ...', () => {
    cy.getByTestId('accordion').find(selectors.accordion.trigger).contains('Show more')
    cy.getByTestId('accordion').find(selectors.accordion.content).contains('My Content')
  })
})
```

### Component Commands

#### getByTestId

Gets the element / component by the attribute `data-testid` and waits until fully loaded.
Internally it calls `waitForComponents`.

```typescript
cy.getByTestId('button')
```

#### waitForDesignSystem

Waits until the custom font has loaded, Design System is initialized, web-components are ready
and first browser print has fulfilled. Moreover, it disables all the animations for more stable
and faster tests.

```typescript
cy.waitForDesignSystem()
```

#### waitForComponents

Waits until the component has fully loaded.

```typescript
cy.get('button').waitForComponents()
```

#### Viewport / Platform

The `platform` commands allows to switch between the breakpoints of the Design System

```typescript
cy.platform('mobile')
cy.platform('tablet')
cy.platform('desktop')
```

### Links

- [Testing Package](https://github.com/baloise/design-system/blob/main/packages/testing)
- [Selectors](https://github.com/baloise/design-system/blob/main/packages/testing/src/index.ts)
- [Custom Commands](https://github.com/baloise/design-system/blob/main/packages/testing/src/commands/custom)
- [Override Commands](https://github.com/baloise/design-system/blob/main/packages/testing/src/commands/overrides)

<bal-doc-github link="/stories/development/guides/22-testing.stories.mdx"></bal-doc-github>
