name: 👷 Continuous

on:
  push:
    branches:
      - main
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # build:
  #   name: 🏗️ Lint, Test & Build
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15
  #   env:
  #     HUSKY: 0
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - uses: ./.github/workflows/actions/build
  #       with:
  #         build: true
  #         token: ${{ secrets.GITHUB_TOKEN }}

  # e2e-components:
  #   name: 🧪 Component Tests
  #   runs-on: ubuntu-22.04
  #   timeout-minutes: 30
  #   env:
  #     HUSKY: 0
  #   needs: [build]
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - uses: ./.github/workflows/actions/setup
  #     - uses: ./.github/workflows/actions/e2e-setup
  #     - uses: ./.github/workflows/actions/e2e-components

  # e2e-visual:
  #   name: 🧪 E2E Tests
  #   runs-on: ubuntu-22.04
  #   timeout-minutes: 30
  #   env:
  #     HUSKY: 0
  #   needs: [build]
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       containers: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - uses: ./.github/workflows/actions/setup
  #     - uses: ./.github/workflows/actions/e2e-setup
  #     - uses: ./.github/workflows/actions/e2e-visual

  snapshot:
    name: 📸 Update Snapshots
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      contents: write   # needed for pushing commits
      pull-requests: write
    env:
      HUSKY: 0
      CI: true
    container:
      image: mcr.microsoft.com/playwright:v1.50.1-noble
      options: --user 1001
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRE_RELEASE_GITHUB_TOKEN }}
          fetch-depth: 0
          ref: ${{ github.head_ref }} # <-- checkout the PR branch

      - uses: ./.github/workflows/actions/setup

      - name: Clean install
        run: npm ci

      - name: Build
        run: npx nx run-many -t build

      - name: Run Playwright tests
        run: npx nx run core:e2e-update-screenshots

      - name: Commit snapshots
        uses: EndBug/add-and-commit@v9
        with:
          add: "."
          message: 'update snapshots'
        env:
          GITHUB_TOKEN: ${{ secrets.PRE_RELEASE_GITHUB_TOKEN }}

  # playwright:
  # name: 🧪 Playwright
  # runs-on: ubuntu-22.04
  # timeout-minutes: 30
  # env:
  #   HUSKY: 0
  #   CI: true
  # container:
  #   image: mcr.microsoft.com/playwright:v1.50.1-noble
  #   options: --user 1001
  # steps:
  #   - uses: actions/checkout@v4
  #     with:
  #       fetch-depth: 0

  #   - uses: ./.github/workflows/actions/setup

  #   - name: GITHUB_CONTEXT
  #     run: echo "$GITHUB_CONTEXT"

  #   - name: Clean install
  #     run: npm ci

  #   - name: Build
  #     run: npx nx run-many -t build

  #   - name: Run Playwright tests
  #     run: npx nx run core:e2e-update-screenshots

  #   - name: Upload Playwright HTML report
  #     if: always()
  #     uses: actions/upload-artifact@v4
  #     with:
  #       name: playwright-report
  #       path: playwright-report
  #       retention-days: 7

  # angular:
  #   name: 🧪 Angular Tests
  #   runs-on: ubuntu-22.04
  #   timeout-minutes: 30
  #   env:
  #     HUSKY: 0
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       apps: [v17, v18, v19]
  #   needs: [build]
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #     - uses: ./.github/workflows/actions/setup
  #     - uses: ./.github/workflows/actions/angular-setup
  #       with:
  #         app: ${{ matrix.apps }}
  #     - uses: ./.github/workflows/actions/angular-build
  #       with:
  #         app: ${{ matrix.apps }}
  #     - uses: ./.github/workflows/actions/angular-test
  #       with:
  #         app: ${{ matrix.apps }}
